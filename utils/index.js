"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.processSpreadsheet = exports.checkSpreadsheet = exports.buildLocations = exports.getPhotos = exports.getWikimediaPhotoData = exports.parseCoordinates = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
var XLSX = require("xlsx");
require("dotenv").config({ path: ".env.local" });
const aws_1 = require("./aws");
const photoLinks_1 = require("./photoLinks");
require("isomorphic-fetch");
const COLUMN_COUNTY = "County";
const COLUMN_CITY = "City/town";
const COLUMN_NAME = "Name of location";
const COLUMN_LATITUDE = "Latitude";
const COLUMN_LONGITUDE = "Longitude";
const COLUMN_DESCRIPTION = "Description of map point";
const COLUMN_CHALLENGE = "Challenge";
const ROWS_TO_SKIP = 0;
const PHOTOS_BASEURL = process.env.PHOTOS_BASEURL;
var workbook = XLSX.readFile(process.env.SOURCE_SPREADSHEET_PATH);
const sheetNames = [...workbook.SheetNames];
// Skip the overview sheet
sheetNames.shift();
// Each sheet has a different name for the column...
function getPhotoColumnKey(sheetJson) {
    let photoColumnKey = undefined;
    sheetJson.forEach((row) => {
        photoColumnKey =
            photoColumnKey ||
                Object.keys(row).find((key) => key.includes("folder") || key.toLowerCase().includes("image"));
    });
    return photoColumnKey;
}
function sanitise(input) {
    return input ? input.toLowerCase().replace(/[^a-z0-9]/gi, "") : "";
}
function createLocationId(county, city, name) {
    return `${sanitise(county)}-${sanitise(city)}-${sanitise(name)}`;
}
const REGEX_DEG_MIN_SEC = /^\s*([+-]?\d+)\D+(\d+)\D+(\d+(\.\d+)?)\D*$/;
function getOrdinate(input) {
    if (typeof input === "number") {
        return Number.isInteger(input) ? 0 : input;
    }
    const result = input ? parseFloat(input.trim()) : 0;
    if (!result || Number.isNaN(result)) {
        // Input is unlikely to be valid ordinate
        return 0;
    }
    if (!Number.isInteger(result)) {
        return result;
    }
    // Integer suggests degree minute second format - attempt to parse
    const components = input.match(REGEX_DEG_MIN_SEC);
    if (!components) {
        return 0;
    }
    return (parseFloat(components[1]) +
        parseFloat(components[2]) / 60 +
        parseFloat(components[3]) / 3600);
}
function parseCoordinates(inputLatitude, inputLongitude) {
    const latitude = getOrdinate(inputLatitude);
    let longitude = getOrdinate(inputLongitude);
    if (!latitude || !longitude) {
        // One of the ordinates is probably bad
        console.warn("Probably bad lat/long: ", inputLatitude, inputLongitude);
        return undefined;
    }
    // Handle incorrect signs for longitudes - everything is west of prime meridian
    longitude = -Math.abs(longitude);
    if (latitude < 50 || latitude > 61 || longitude < -9 || longitude > 0) {
        // Out of range coordinates
        console.warn("Probably transposed lat/long: ", inputLatitude, inputLongitude);
        return undefined;
    }
    return { latitude, longitude };
}
exports.parseCoordinates = parseCoordinates;
async function getWikimediaPhotoData(wikiUrl) {
    const wikiFile = wikiUrl.substring("https://commons.wikimedia.org/wiki/File:".length);
    const queryUrl = `https://en.wikipedia.org/w/api.php?format=json&action=query&titles=File:${wikiFile}&prop=imageinfo&iiprop=user|extmetadata|url&iiextmetadatafilter=LicenseShortName&iiurlwidth=640`;
    const response = await fetch(queryUrl, { method: "GET" })
        .then((data) => data.json())
        .catch((err) => {
        console.error(err);
    });
    const imageinfo = Object.values(response.query.pages)[0]
        .imageinfo[0];
    return {
        imageUrl: imageinfo.thumburl,
        filename: imageinfo.thumburl.split("/").pop(),
        originalUrl: wikiUrl,
        attribution: imageinfo.user,
        copyright: imageinfo.extmetadata.LicenseShortName.value,
    };
}
exports.getWikimediaPhotoData = getWikimediaPhotoData;
let photoLinkCount = 0;
let photoFileCount = 0;
async function getPhotos(locationId, photoRef) {
    const photos = [];
    if (photoLinks_1.PHOTO_LINKS[photoRef]) {
        // Already processed linked (or file with attribution) photo - skip fetching again
        console.log("Using archived photo link", photoRef);
        const archivedPhoto = photoLinks_1.PHOTO_LINKS[photoRef];
        photos.push({
            url: `${PHOTOS_BASEURL}/${archivedPhoto.file}`,
            attribution: archivedPhoto.attribution,
            copyright: archivedPhoto.copyright,
            originalUrl: archivedPhoto.originalUrl,
        });
        photoLinkCount++;
    }
    else if (photoRef === null || photoRef === void 0 ? void 0 : photoRef.startsWith("https://commons.wikimedia.org/wiki/File:")) {
        // Linked wikimedia photo
        const wikiPhotoData = await getWikimediaPhotoData(photoRef);
        // Throttle fetch rate to avoid annoying wikimedia
        await new Promise((r) => setTimeout(r, 2000));
        const photo = {
            url: `${PHOTOS_BASEURL}/${wikiPhotoData.filename}`,
            attribution: wikiPhotoData.attribution,
            copyright: wikiPhotoData.copyright,
            originalUrl: wikiPhotoData.originalUrl,
        };
        console.log("Upload this photo to the photos bucket:");
        console.log(wikiPhotoData.imageUrl);
        console.log("Then add the following to PHOTO_LINKS:");
        console.log(`"${photoRef}": ${JSON.stringify({
            file: wikiPhotoData.filename,
            attribution: wikiPhotoData.attribution,
            copyright: wikiPhotoData.copyright,
            originalUrl: wikiPhotoData.originalUrl,
        })},`);
        photos.push(photo);
        photoLinkCount++;
    }
    else if (photoRef === null || photoRef === void 0 ? void 0 : photoRef.includes("http")) {
        // Linked photo - manually process and add to PHOTO_LINKS
        console.log("Unprocessed photo link", locationId, photoRef);
        photoLinkCount++;
    }
    else if (photoRef) {
        // File photo - no attribution or copyright requested
        photos.push({
            url: `${PHOTOS_BASEURL}/${locationId}.jpg`,
        });
        console.log("Photo file", `${locationId}.jpg`);
        photoFileCount++;
    }
    return photos;
}
exports.getPhotos = getPhotos;
async function buildLocations(workbook) {
    let successCount = 0;
    let failCount = 0;
    photoLinkCount = 0;
    photoFileCount = 0;
    const result = [];
    for (let sheetName of sheetNames) {
        const contents = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {
            range: ROWS_TO_SKIP,
        });
        // TODO photo handling
        let photoColumnKey = getPhotoColumnKey(contents);
        console.log("Sheet", sheetName);
        // Some column values carry forward (ie not populated in succeeding rows)
        let county = "";
        let city = undefined;
        for (let row of contents) {
            // console.log(row);
            const newCounty = row[COLUMN_COUNTY];
            if (newCounty) {
                county = newCounty;
                city = undefined;
            }
            city = row[COLUMN_CITY] || city;
            const name = row[COLUMN_NAME];
            const locationId = createLocationId(county, city, name);
            const photos = await getPhotos(locationId, row[photoColumnKey]);
            const coordinates = parseCoordinates(row[COLUMN_LATITUDE], row[COLUMN_LONGITUDE]);
            const description = row[COLUMN_DESCRIPTION];
            const challenge = row[COLUMN_CHALLENGE];
            if (!coordinates) {
                console.warn("Incomplete location coordinates: ", sheetName, {
                    [COLUMN_COUNTY]: county,
                    [COLUMN_CITY]: city,
                    [COLUMN_NAME]: row[COLUMN_NAME],
                    [COLUMN_LATITUDE]: row[COLUMN_LATITUDE],
                    [COLUMN_LONGITUDE]: row[COLUMN_LONGITUDE],
                }, row);
                failCount++;
            }
            else if (!name || !county || !description || !challenge) {
                console.warn("Incomplete location information: ", sheetName, {
                    [COLUMN_COUNTY]: county,
                    [COLUMN_CITY]: city,
                    ...row,
                });
                failCount++;
            }
            else {
                result.push({
                    locationId,
                    region: sheetName,
                    county,
                    city,
                    latitude: coordinates.latitude,
                    longitude: coordinates.longitude,
                    name,
                    description,
                    challenge,
                    photos,
                });
                successCount++;
            }
        }
    }
    console.log("success: ", successCount);
    console.log("fail: ", failCount);
    console.log("photo links: ", photoLinkCount);
    console.log("photo files: ", photoFileCount);
    return result;
}
exports.buildLocations = buildLocations;
async function uploadToDynamoDB(locations) {
    const locationsTableName = process.env.LOCATIONS_TABLE_NAME;
    console.log("Loading location data into DynamoDB", locationsTableName);
    for (let location of locations) {
        const result = await aws_1.dynamodbClient.send(new client_dynamodb_1.PutItemCommand({
            TableName: locationsTableName,
            Item: (0, util_dynamodb_1.marshall)(location, { removeUndefinedValues: true }),
        }));
    }
}
async function checkSpreadsheet() {
    const locations = await buildLocations(workbook);
    locations.forEach((location) => {
        console.log(location.locationId, location.name);
    });
    return locations.length;
}
exports.checkSpreadsheet = checkSpreadsheet;
async function processSpreadsheet() {
    const locations = await buildLocations(workbook);
    locations.forEach((location) => {
        console.log(location.locationId, location.name);
    });
    await uploadToDynamoDB(locations);
}
exports.processSpreadsheet = processSpreadsheet;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBeUU7QUFDekUsMERBQWtEO0FBQ2xELElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7QUFDakQsK0JBQXVDO0FBQ3ZDLDZDQUEyQztBQUMzQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQThCNUIsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDO0FBQy9CLE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQztBQUNoQyxNQUFNLFdBQVcsR0FBRyxrQkFBa0IsQ0FBQztBQUN2QyxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUM7QUFDbkMsTUFBTSxnQkFBZ0IsR0FBRyxXQUFXLENBQUM7QUFDckMsTUFBTSxrQkFBa0IsR0FBRywwQkFBMEIsQ0FBQztBQUN0RCxNQUFNLGdCQUFnQixHQUFHLFdBQVcsQ0FBQztBQUVyQyxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUM7QUFFdkIsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7QUFFbEQsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFFbEUsTUFBTSxVQUFVLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUM1QywwQkFBMEI7QUFDMUIsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBRW5CLG9EQUFvRDtBQUNwRCxTQUFTLGlCQUFpQixDQUFDLFNBQWM7SUFDdkMsSUFBSSxjQUFjLEdBQXVCLFNBQVMsQ0FBQztJQUNuRCxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBd0Is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O0lBRUgsT0FBTyxTQUFTLENBQUMsTUFBTSxDQUFDO0FBQzFCLENBQUM7QUFSRCw0Q0FRQztBQUVNLEtBQUssVUFBVSxrQkFBa0I7SUFDdEMsTUFBTSxTQUFTLEdBQUcsTUFBTSxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFakQsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO1FBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEQsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3BDLENBQUM7QUFSRCxnREFRQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFB1dEl0ZW1Db21tYW5kLCBQdXRJdGVtT3V0cHV0IH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1keW5hbW9kYlwiO1xuaW1wb3J0IHsgbWFyc2hhbGwgfSBmcm9tIFwiQGF3cy1zZGsvdXRpbC1keW5hbW9kYlwiO1xudmFyIFhMU1ggPSByZXF1aXJlKFwieGxzeFwiKTtcbnJlcXVpcmUoXCJkb3RlbnZcIikuY29uZmlnKHsgcGF0aDogXCIuZW52LmxvY2FsXCIgfSk7XG5pbXBvcnQgeyBkeW5hbW9kYkNsaWVudCB9IGZyb20gXCIuL2F3c1wiO1xuaW1wb3J0IHsgUEhPVE9fTElOS1MgfSBmcm9tIFwiLi9waG90b0xpbmtzXCI7XG5yZXF1aXJlKFwiaXNvbW9ycGhpYy1mZXRjaFwiKTtcblxudHlwZSBHR1NQaG90byA9IHtcbiAgdXJsOiBzdHJpbmc7XG4gIG9yaWdpbmFsVXJsPzogc3RyaW5nO1xuICBjb3B5cmlnaHQ/OiBzdHJpbmc7XG4gIGF0dHJpYnV0aW9uPzogc3RyaW5nO1xufTtcblxudHlwZSBHR1NMb2NhdGlvbiA9IHtcbiAgbG9jYXRpb25JZDogc3RyaW5nO1xuICByZWdpb246IHN0cmluZztcbiAgY291bnR5OiBzdHJpbmc7XG4gIGNpdHk/OiBzdHJpbmc7XG4gIGxhdGl0dWRlOiBudW1iZXI7XG4gIGxvbmdpdHVkZTogbnVtYmVyO1xuICBuYW1lOiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gIGNoYWxsZW5nZTogc3RyaW5nO1xuICBwaG90b3M6IEdHU1Bob3RvW107XG59O1xuXG50eXBlIFdpa2ltZWRpYVBob3RvID0ge1xuICBpbWFnZVVybDogc3RyaW5nO1xuICBmaWxlbmFtZTogc3RyaW5nO1xuICBvcmlnaW5hbFVybDogc3RyaW5nO1xuICBhdHRyaWJ1dGlvbjogc3RyaW5nO1xuICBjb3B5cmlnaHQ6IHN0cmluZztcbn07XG5cbmNvbnN0IENPTFVNTl9DT1VOVFkgPSBcIkNvdW50eVwiO1xuY29uc3QgQ09MVU1OX0NJVFkgPSBcIkNpdHkvdG93blwiO1xuY29uc3QgQ09MVU1OX05BTUUgPSBcIk5hbWUgb2YgbG9jYXRpb25cIjtcbmNvbnN0IENPTFVNTl9MQVRJVFVERSA9IFwiTGF0aXR1ZGVcIjtcbmNvbnN0IENPTFVNTl9MT05HSVRVREUgPSBcIkxvbmdpdHVkZVwiO1xuY29uc3QgQ09MVU1OX0RFU0NSSVBUSU9OID0gXCJEZXNjcmlwdGlvbiBvZiBtYXAgcG9pbnRcIjtcbmNvbnN0IENPTFVNTl9DSEFMTEVOR0UgPSBcIkNoYWxsZW5nZVwiO1xuXG5jb25zdCBST1dTX1RPX1NLSVAgPSAwO1xuXG5jb25zdCBQSE9UT1NfQkFTRVVSTCA9IHByb2Nlc3MuZW52LlBIT1RPU19CQVNFVVJMO1xuXG52YXIgd29ya2Jvb2sgPSBYTFNYLnJlYWRGaWxlKHByb2Nlc3MuZW52LlNPVVJDRV9TUFJFQURTSEVFVF9QQVRIKTtcblxuY29uc3Qgc2hlZXROYW1lcyA9IFsuLi53b3JrYm9vay5TaGVldE5hbWVzXTtcbi8vIFNraXAgdGhlIG92ZXJ2aWV3IHNoZWV0XG5zaGVldE5hbWVzLnNoaWZ0KCk7XG5cbi8vIEVhY2ggc2hlZXQgaGFzIGEgZGlmZmVyZW50IG5hbWUgZm9yIHRoZSBjb2x1bW4uLi5cbmZ1bmN0aW9uIGdldFBob3RvQ29sdW1uS2V5KHNoZWV0SnNvbjogYW55KTogc3RyaW5nIHtcbiAgbGV0IHBob3RvQ29sdW1uS2V5OiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gIHNoZWV0SnNvbi5mb3JFYWNoKChyb3c6IFJlY29yZDxzdHJpbmcsIGFueT4pID0+IHtcbiAgICBwaG90b0NvbHVtbktleSA9XG4gICAgICBwaG90b0NvbHVtbktleSB8fFxuICAgICAgT2JqZWN0LmtleXMocm93KS5maW5kKFxuICAgICAgICAoa2V5KSA9PiBrZXkuaW5jbHVkZXMoXCJmb2xkZXJcIikgfHwga2V5LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoXCJpbWFnZVwiKVxuICAgICAgKTtcbiAgfSk7XG4gIHJldHVybiBwaG90b0NvbHVtbktleSE7XG59XG5cbmZ1bmN0aW9uIHNhbml0aXNlKGlucHV0Pzogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGlucHV0ID8gaW5wdXQudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9bXmEtejAtOV0vZ2ksIFwiXCIpIDogXCJcIjtcbn1cblxuZnVuY3Rpb24gY3JlYXRlTG9jYXRpb25JZChcbiAgY291bnR5OiBzdHJpbmcsXG4gIGNpdHk6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgbmFtZTogc3RyaW5nXG4pIHtcbiAgcmV0dXJuIGAke3Nhbml0aXNlKGNvdW50eSl9LSR7c2FuaXRpc2UoY2l0eSl9LSR7c2FuaXRpc2UobmFtZSl9YDtcbn1cblxudHlwZSBDb29yZGluYXRlID0ge1xuICBsYXRpdHVkZTogbnVtYmVyO1xuICBsb25naXR1ZGU6IG51bWJlcjtcbn07XG5cbmNvbnN0IFJFR0VYX0RFR19NSU5fU0VDID0gL15cXHMqKFsrLV0/XFxkKylcXEQrKFxcZCspXFxEKyhcXGQrKFxcLlxcZCspPylcXEQqJC87XG5cbmZ1bmN0aW9uIGdldE9yZGluYXRlKGlucHV0OiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQpOiBudW1iZXIge1xuICBpZiAodHlwZW9mIGlucHV0ID09PSBcIm51bWJlclwiKSB7XG4gICAgcmV0dXJuIE51bWJlci5pc0ludGVnZXIoaW5wdXQpID8gMCA6IGlucHV0O1xuICB9XG5cbiAgY29uc3QgcmVzdWx0ID0gaW5wdXQgPyBwYXJzZUZsb2F0KGlucHV0LnRyaW0oKSkgOiAwO1xuICBpZiAoIXJlc3VsdCB8fCBOdW1iZXIuaXNOYU4ocmVzdWx0KSkge1xuICAgIC8vIElucHV0IGlzIHVubGlrZWx5IHRvIGJlIHZhbGlkIG9yZGluYXRlXG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICBpZiAoIU51bWJlci5pc0ludGVnZXIocmVzdWx0KSkge1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvLyBJbnRlZ2VyIHN1Z2dlc3RzIGRlZ3JlZSBtaW51dGUgc2Vjb25kIGZvcm1hdCAtIGF0dGVtcHQgdG8gcGFyc2VcbiAgY29uc3QgY29tcG9uZW50cyA9IGlucHV0IS5tYXRjaChSRUdFWF9ERUdfTUlOX1NFQyk7XG4gIGlmICghY29tcG9uZW50cykge1xuICAgIHJldHVybiAwO1xuICB9XG5cbiAgcmV0dXJuIChcbiAgICBwYXJzZUZsb2F0KGNvbXBvbmVudHNbMV0pICtcbiAgICBwYXJzZUZsb2F0KGNvbXBvbmVudHNbMl0pIC8gNjAgK1xuICAgIHBhcnNlRmxvYXQoY29tcG9uZW50c1szXSkgLyAzNjAwXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUNvb3JkaW5hdGVzKFxuICBpbnB1dExhdGl0dWRlOiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQsXG4gIGlucHV0TG9uZ2l0dWRlOiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWRcbik6IENvb3JkaW5hdGUgfCB1bmRlZmluZWQge1xuICBjb25zdCBsYXRpdHVkZSA9IGdldE9yZGluYXRlKGlucHV0TGF0aXR1ZGUpO1xuICBsZXQgbG9uZ2l0dWRlID0gZ2V0T3JkaW5hdGUoaW5wdXRMb25naXR1ZGUpO1xuXG4gIGlmICghbGF0aXR1ZGUgfHwgIWxvbmdpdHVkZSkge1xuICAgIC8vIE9uZSBvZiB0aGUgb3JkaW5hdGVzIGlzIHByb2JhYmx5IGJhZFxuICAgIGNvbnNvbGUud2FybihcIlByb2JhYmx5IGJhZCBsYXQvbG9uZzogXCIsIGlucHV0TGF0aXR1ZGUsIGlucHV0TG9uZ2l0dWRlKTtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLy8gSGFuZGxlIGluY29ycmVjdCBzaWducyBmb3IgbG9uZ2l0dWRlcyAtIGV2ZXJ5dGhpbmcgaXMgd2VzdCBvZiBwcmltZSBtZXJpZGlhblxuICBsb25naXR1ZGUgPSAtTWF0aC5hYnMobG9uZ2l0dWRlKTtcblxuICBpZiAobGF0aXR1ZGUgPCA1MCB8fCBsYXRpdHVkZSA+IDYxIHx8IGxvbmdpdHVkZSA8IC05IHx8IGxvbmdpdHVkZSA+IDApIHtcbiAgICAvLyBPdXQgb2YgcmFuZ2UgY29vcmRpbmF0ZXNcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICBcIlByb2JhYmx5IHRyYW5zcG9zZWQgbGF0L2xvbmc6IFwiLFxuICAgICAgaW5wdXRMYXRpdHVkZSxcbiAgICAgIGlucHV0TG9uZ2l0dWRlXG4gICAgKTtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcmV0dXJuIHsgbGF0aXR1ZGUsIGxvbmdpdHVkZSB9O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0V2lraW1lZGlhUGhvdG9EYXRhKFxuICB3aWtpVXJsOiBzdHJpbmdcbik6IFByb21pc2U8V2lraW1lZGlhUGhvdG8+IHtcbiAgY29uc3Qgd2lraUZpbGUgPSB3aWtpVXJsLnN1YnN0cmluZyhcbiAgICBcImh0dHBzOi8vY29tbW9ucy53aWtpbWVkaWEub3JnL3dpa2kvRmlsZTpcIi5sZW5ndGhcbiAgKTtcblxuICBjb25zdCBxdWVyeVVybCA9IGBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvdy9hcGkucGhwP2Zvcm1hdD1qc29uJmFjdGlvbj1xdWVyeSZ0aXRsZXM9RmlsZToke3dpa2lGaWxlfSZwcm9wPWltYWdlaW5mbyZpaXByb3A9dXNlcnxleHRtZXRhZGF0YXx1cmwmaWlleHRtZXRhZGF0YWZpbHRlcj1MaWNlbnNlU2hvcnROYW1lJmlpdXJsd2lkdGg9NjQwYDtcblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHF1ZXJ5VXJsLCB7IG1ldGhvZDogXCJHRVRcIiB9KVxuICAgIC50aGVuKChkYXRhKSA9PiBkYXRhLmpzb24oKSlcbiAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgIH0pO1xuICBjb25zdCBpbWFnZWluZm8gPSAoT2JqZWN0LnZhbHVlcyhyZXNwb25zZS5xdWVyeS5wYWdlcylbMF0gYXMgYW55KVxuICAgIC5pbWFnZWluZm9bMF07XG4gIHJldHVybiB7XG4gICAgaW1hZ2VVcmw6IGltYWdlaW5mby50aHVtYnVybCxcbiAgICBmaWxlbmFtZTogaW1hZ2VpbmZvLnRodW1idXJsLnNwbGl0KFwiL1wiKS5wb3AoKSxcbiAgICBvcmlnaW5hbFVybDogd2lraVVybCxcbiAgICBhdHRyaWJ1dGlvbjogaW1hZ2VpbmZvLnVzZXIsXG4gICAgY29weXJpZ2h0OiBpbWFnZWluZm8uZXh0bWV0YWRhdGEuTGljZW5zZVNob3J0TmFtZS52YWx1ZSxcbiAgfTtcbn1cblxubGV0IHBob3RvTGlua0NvdW50ID0gMDtcbmxldCBwaG90b0ZpbGVDb3VudCA9IDA7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQaG90b3MobG9jYXRpb25JZDogc3RyaW5nLCBwaG90b1JlZjogc3RyaW5nKSB7XG4gIGNvbnN0IHBob3RvczogR0dTUGhvdG9bXSA9IFtdO1xuXG4gIGlmIChQSE9UT19MSU5LU1twaG90b1JlZl0pIHtcbiAgICAvLyBBbHJlYWR5IHByb2Nlc3NlZCBsaW5rZWQgKG9yIGZpbGUgd2l0aCBhdHRyaWJ1dGlvbikgcGhvdG8gLSBza2lwIGZldGNoaW5nIGFnYWluXG4gICAgY29uc29sZS5sb2coXCJVc2luZyBhcmNoaXZlZCBwaG90byBsaW5rXCIsIHBob3RvUmVmKTtcbiAgICBjb25zdCBhcmNoaXZlZFBob3RvID0gUEhPVE9fTElOS1NbcGhvdG9SZWZdO1xuICAgIHBob3Rvcy5wdXNoKHtcbiAgICAgIHVybDogYCR7UEhPVE9TX0JBU0VVUkx9LyR7YXJjaGl2ZWRQaG90by5maWxlfWAsXG4gICAgICBhdHRyaWJ1dGlvbjogYXJjaGl2ZWRQaG90by5hdHRyaWJ1dGlvbixcbiAgICAgIGNvcHlyaWdodDogYXJjaGl2ZWRQaG90by5jb3B5cmlnaHQsXG4gICAgICBvcmlnaW5hbFVybDogYXJjaGl2ZWRQaG90by5vcmlnaW5hbFVybCxcbiAgICB9KTtcbiAgICBwaG90b0xpbmtDb3VudCsrO1xuICB9IGVsc2UgaWYgKHBob3RvUmVmPy5zdGFydHNXaXRoKFwiaHR0cHM6Ly9jb21tb25zLndpa2ltZWRpYS5vcmcvd2lraS9GaWxlOlwiKSkge1xuICAgIC8vIExpbmtlZCB3aWtpbWVkaWEgcGhvdG9cbiAgICBjb25zdCB3aWtpUGhvdG9EYXRhID0gYXdhaXQgZ2V0V2lraW1lZGlhUGhvdG9EYXRhKHBob3RvUmVmKTtcbiAgICAvLyBUaHJvdHRsZSBmZXRjaCByYXRlIHRvIGF2b2lkIGFubm95aW5nIHdpa2ltZWRpYVxuICAgIGF3YWl0IG5ldyBQcm9taXNlKChyKSA9PiBzZXRUaW1lb3V0KHIsIDIwMDApKTtcbiAgICBjb25zdCBwaG90byA9IHtcbiAgICAgIHVybDogYCR7UEhPVE9TX0JBU0VVUkx9LyR7d2lraVBob3RvRGF0YS5maWxlbmFtZX1gLFxuICAgICAgYXR0cmlidXRpb246IHdpa2lQaG90b0RhdGEuYXR0cmlidXRpb24sXG4gICAgICBjb3B5cmlnaHQ6IHdpa2lQaG90b0RhdGEuY29weXJpZ2h0LFxuICAgICAgb3JpZ2luYWxVcmw6IHdpa2lQaG90b0RhdGEub3JpZ2luYWxVcmwsXG4gICAgfTtcbiAgICBjb25zb2xlLmxvZyhcIlVwbG9hZCB0aGlzIHBob3RvIHRvIHRoZSBwaG90b3MgYnVja2V0OlwiKTtcbiAgICBjb25zb2xlLmxvZyh3aWtpUGhvdG9EYXRhLmltYWdlVXJsKTtcbiAgICBjb25zb2xlLmxvZyhcIlRoZW4gYWRkIHRoZSBmb2xsb3dpbmcgdG8gUEhPVE9fTElOS1M6XCIpO1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgYFwiJHtwaG90b1JlZn1cIjogJHtKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGZpbGU6IHdpa2lQaG90b0RhdGEuZmlsZW5hbWUsXG4gICAgICAgIGF0dHJpYnV0aW9uOiB3aWtpUGhvdG9EYXRhLmF0dHJpYnV0aW9uLFxuICAgICAgICBjb3B5cmlnaHQ6IHdpa2lQaG90b0RhdGEuY29weXJpZ2h0LFxuICAgICAgICBvcmlnaW5hbFVybDogd2lraVBob3RvRGF0YS5vcmlnaW5hbFVybCxcbiAgICAgIH0pfSxgXG4gICAgKTtcbiAgICBwaG90b3MucHVzaChwaG90byk7XG4gICAgcGhvdG9MaW5rQ291bnQrKztcbiAgfSBlbHNlIGlmIChwaG90b1JlZj8uaW5jbHVkZXMoXCJodHRwXCIpKSB7XG4gICAgLy8gTGlua2VkIHBob3RvIC0gbWFudWFsbHkgcHJvY2VzcyBhbmQgYWRkIHRvIFBIT1RPX0xJTktTXG4gICAgY29uc29sZS5sb2coXCJVbnByb2Nlc3NlZCBwaG90byBsaW5rXCIsIGxvY2F0aW9uSWQsIHBob3RvUmVmKTtcbiAgICBwaG90b0xpbmtDb3VudCsrO1xuICB9IGVsc2UgaWYgKHBob3RvUmVmKSB7XG4gICAgLy8gRmlsZSBwaG90byAtIG5vIGF0dHJpYnV0aW9uIG9yIGNvcHlyaWdodCByZXF1ZXN0ZWRcbiAgICBwaG90b3MucHVzaCh7XG4gICAgICB1cmw6IGAke1BIT1RPU19CQVNFVVJMfS8ke2xvY2F0aW9uSWR9LmpwZ2AsXG4gICAgfSk7XG4gICAgY29uc29sZS5sb2coXCJQaG90byBmaWxlXCIsIGAke2xvY2F0aW9uSWR9LmpwZ2ApO1xuICAgIFxuICAgIHBob3RvRmlsZUNvdW50Kys7XG4gIH1cbiAgcmV0dXJuIHBob3Rvcztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJ1aWxkTG9jYXRpb25zKHdvcmtib29rOiBhbnkpOiBQcm9taXNlPEdHU0xvY2F0aW9uW10+IHtcbiAgbGV0IHN1Y2Nlc3NDb3VudCA9IDA7XG4gIGxldCBmYWlsQ291bnQgPSAwO1xuICBwaG90b0xpbmtDb3VudCA9IDA7XG4gIHBob3RvRmlsZUNvdW50ID0gMDtcbiAgY29uc3QgcmVzdWx0OiBHR1NMb2NhdGlvbltdID0gW107XG5cbiAgZm9yIChsZXQgc2hlZXROYW1lIG9mIHNoZWV0TmFtZXMpIHtcbiAgICBjb25zdCBjb250ZW50cyA9IFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbih3b3JrYm9vay5TaGVldHNbc2hlZXROYW1lXSwge1xuICAgICAgcmFuZ2U6IFJPV1NfVE9fU0tJUCxcbiAgICB9KTtcbiAgICAvLyBUT0RPIHBob3RvIGhhbmRsaW5nXG4gICAgbGV0IHBob3RvQ29sdW1uS2V5ID0gZ2V0UGhvdG9Db2x1bW5LZXkoY29udGVudHMpO1xuXG4gICAgY29uc29sZS5sb2coXCJTaGVldFwiLCBzaGVldE5hbWUpO1xuXG4gICAgLy8gU29tZSBjb2x1bW4gdmFsdWVzIGNhcnJ5IGZvcndhcmQgKGllIG5vdCBwb3B1bGF0ZWQgaW4gc3VjY2VlZGluZyByb3dzKVxuICAgIGxldCBjb3VudHk6IHN0cmluZyA9IFwiXCI7XG4gICAgbGV0IGNpdHk6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcblxuICAgIGZvciAobGV0IHJvdyBvZiBjb250ZW50cykge1xuICAgICAgLy8gY29uc29sZS5sb2cocm93KTtcbiAgICAgIFxuICAgICAgY29uc3QgbmV3Q291bnR5ID0gcm93W0NPTFVNTl9DT1VOVFldO1xuICAgICAgaWYgKG5ld0NvdW50eSkge1xuICAgICAgICBjb3VudHkgPSBuZXdDb3VudHk7XG4gICAgICAgIGNpdHkgPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICBjaXR5ID0gcm93W0NPTFVNTl9DSVRZXSB8fCBjaXR5O1xuICAgICAgY29uc3QgbmFtZSA9IHJvd1tDT0xVTU5fTkFNRV07XG4gICAgICBjb25zdCBsb2NhdGlvbklkID0gY3JlYXRlTG9jYXRpb25JZChjb3VudHksIGNpdHksIG5hbWUpO1xuXG4gICAgICBjb25zdCBwaG90b3M6IEdHU1Bob3RvW10gPSBhd2FpdCBnZXRQaG90b3MoXG4gICAgICAgIGxvY2F0aW9uSWQsXG4gICAgICAgIHJvd1twaG90b0NvbHVtbktleV1cbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gcGFyc2VDb29yZGluYXRlcyhcbiAgICAgICAgcm93W0NPTFVNTl9MQVRJVFVERV0sXG4gICAgICAgIHJvd1tDT0xVTU5fTE9OR0lUVURFXVxuICAgICAgKTtcblxuICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSByb3dbQ09MVU1OX0RFU0NSSVBUSU9OXTtcbiAgICAgIGNvbnN0IGNoYWxsZW5nZSA9IHJvd1tDT0xVTU5fQ0hBTExFTkdFXTtcbiAgICAgIGlmICghY29vcmRpbmF0ZXMpIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwiSW5jb21wbGV0ZSBsb2NhdGlvbiBjb29yZGluYXRlczogXCIsIHNoZWV0TmFtZSwge1xuICAgICAgICAgIFtDT0xVTU5fQ09VTlRZXTogY291bnR5LFxuICAgICAgICAgIFtDT0xVTU5fQ0lUWV06IGNpdHksXG4gICAgICAgICAgW0NPTFVNTl9OQU1FXTogcm93W0NPTFVNTl9OQU1FXSxcbiAgICAgICAgICBbQ09MVU1OX0xBVElUVURFXTogcm93W0NPTFVNTl9MQVRJVFVERV0sXG4gICAgICAgICAgW0NPTFVNTl9MT05HSVRVREVdOiByb3dbQ09MVU1OX0xPTkdJVFVERV0sXG4gICAgICAgIH0sIHJvdyk7XG4gICAgICAgIGZhaWxDb3VudCsrO1xuICAgICAgfSBlbHNlIGlmICghbmFtZSB8fCAhY291bnR5IHx8ICFkZXNjcmlwdGlvbiB8fCAhY2hhbGxlbmdlKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihcIkluY29tcGxldGUgbG9jYXRpb24gaW5mb3JtYXRpb246IFwiLCBzaGVldE5hbWUsIHtcbiAgICAgICAgICBbQ09MVU1OX0NPVU5UWV06IGNvdW50eSxcbiAgICAgICAgICBbQ09MVU1OX0NJVFldOiBjaXR5LFxuICAgICAgICAgIC4uLnJvdyxcbiAgICAgICAgfSk7XG4gICAgICAgIGZhaWxDb3VudCsrO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0LnB1c2goe1xuICAgICAgICAgIGxvY2F0aW9uSWQsXG4gICAgICAgICAgcmVnaW9uOiBzaGVldE5hbWUsXG4gICAgICAgICAgY291bnR5LFxuICAgICAgICAgIGNpdHksXG4gICAgICAgICAgbGF0aXR1ZGU6IGNvb3JkaW5hdGVzLmxhdGl0dWRlLFxuICAgICAgICAgIGxvbmdpdHVkZTogY29vcmRpbmF0ZXMubG9uZ2l0dWRlLFxuICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgICAgY2hhbGxlbmdlLFxuICAgICAgICAgIHBob3RvcyxcbiAgICAgICAgfSk7XG4gICAgICAgIHN1Y2Nlc3NDb3VudCsrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbnNvbGUubG9nKFwic3VjY2VzczogXCIsIHN1Y2Nlc3NDb3VudCk7XG4gIGNvbnNvbGUubG9nKFwiZmFpbDogXCIsIGZhaWxDb3VudCk7XG4gIGNvbnNvbGUubG9nKFwicGhvdG8gbGlua3M6IFwiLCBwaG90b0xpbmtDb3VudCk7XG4gIGNvbnNvbGUubG9nKFwicGhvdG8gZmlsZXM6IFwiLCBwaG90b0ZpbGVDb3VudCk7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwbG9hZFRvRHluYW1vREIobG9jYXRpb25zOiBHR1NMb2NhdGlvbltdKSB7XG4gIGNvbnN0IGxvY2F0aW9uc1RhYmxlTmFtZSA9IHByb2Nlc3MuZW52LkxPQ0FUSU9OU19UQUJMRV9OQU1FO1xuICBjb25zb2xlLmxvZyhcIkxvYWRpbmcgbG9jYXRpb24gZGF0YSBpbnRvIER5bmFtb0RCXCIsIGxvY2F0aW9uc1RhYmxlTmFtZSk7XG5cbiAgZm9yIChsZXQgbG9jYXRpb24gb2YgbG9jYXRpb25zKSB7XG4gICAgY29uc3QgcmVzdWx0OiBQdXRJdGVtT3V0cHV0ID0gYXdhaXQgZHluYW1vZGJDbGllbnQuc2VuZChcbiAgICAgIG5ldyBQdXRJdGVtQ29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogbG9jYXRpb25zVGFibGVOYW1lLFxuICAgICAgICBJdGVtOiBtYXJzaGFsbChsb2NhdGlvbiwgeyByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUgfSksXG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNoZWNrU3ByZWFkc2hlZXQoKSB7XG4gIGNvbnN0IGxvY2F0aW9ucyA9IGF3YWl0IGJ1aWxkTG9jYXRpb25zKHdvcmtib29rKTtcblxuICBsb2NhdGlvbnMuZm9yRWFjaCgobG9jYXRpb24pID0+IHtcbiAgICBjb25zb2xlLmxvZyhsb2NhdGlvbi5sb2NhdGlvbklkLCBsb2NhdGlvbi5uYW1lKTtcbiAgfSk7XG5cbiAgcmV0dXJuIGxvY2F0aW9ucy5sZW5ndGg7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcm9jZXNzU3ByZWFkc2hlZXQoKSB7XG4gIGNvbnN0IGxvY2F0aW9ucyA9IGF3YWl0IGJ1aWxkTG9jYXRpb25zKHdvcmtib29rKTtcblxuICBsb2NhdGlvbnMuZm9yRWFjaCgobG9jYXRpb24pID0+IHtcbiAgICBjb25zb2xlLmxvZyhsb2NhdGlvbi5sb2NhdGlvbklkLCBsb2NhdGlvbi5uYW1lKTtcbiAgfSk7XG5cbiAgYXdhaXQgdXBsb2FkVG9EeW5hbW9EQihsb2NhdGlvbnMpO1xufVxuIl19