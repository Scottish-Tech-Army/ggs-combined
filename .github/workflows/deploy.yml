name: Deploy

on:
  workflow_run:
    workflows: Build    # Execute build workflow prior to this one
    branches: main      # Only deploy main branch to production
    types: completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: synth stack
        working-directory: ./cdk
        run: yarn cdk synth

      - name: deploy stack
        working-directory: ./cdk
        run: yarn cdk deploy --all --require-approval never
